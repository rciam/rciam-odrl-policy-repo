# ==============================================================================
# QUARKUS APPLICATION CONFIGURATION
# ==============================================================================

# --- Packaging ---
quarkus.package.type=uber-jar

# --- HTTP / Proxy Settings ---
# Required when behind Nginx/Ingress
quarkus.http.proxy.proxy-address-forwarding=${PROXY_FORWARDING:false}

# --- JSON Serialization ---
# Standardize date formats and robustness
quarkus.jackson.write-dates-as-timestamps=false
quarkus.jackson.fail-on-unknown-properties=false

# ==============================================================================
# DATASOURCE (PostgreSQL)
# ==============================================================================
quarkus.datasource.db-kind=postgresql

# Configuration with Environment Variable overrides (Defaults to localhost)
quarkus.datasource.jdbc.url=${DB_URL:jdbc:postgresql://localhost:5432/odrl_db}
quarkus.datasource.username=${DB_USER:odrl}
quarkus.datasource.password=${DB_PASSWORD:odrl}

# Database Schema Generation
# 'update' is the safest default: it creates tables if missing, updates them if changed,
# and does NOT delete data on restart.
quarkus.hibernate-orm.database.generation=${DB_GENERATION:update}

# Logging (Disable SQL logs by default in Prod to reduce noise)
quarkus.hibernate-orm.log.sql=${LOG_SQL:false}

# ==============================================================================
# OPENAPI & SWAGGER UI
# ==============================================================================
# Expose the OpenAPI document at /openapi
quarkus.smallrye-openapi.path=/openapi

# Always show Swagger UI (useful for debugging, restrict access via Ingress if needed)
quarkus.swagger-ui.always-include=true

# Register the Custom Filter for Dynamic OIDC Configuration
quarkus.smallrye-openapi.filter=gr.grnet.rciam.odrl.api.OpenApiFilter

# Enable scanning so @RolesAllowed annotations are enforced and documented
# even when using a static openapi.yaml
quarkus.smallrye-openapi.scan-disable=false

# ==============================================================================
# SECURITY (OIDC)
# ==============================================================================
# The OIDC Provider URL (Keycloak/Auth0 etc.)
# Default points to the Dev environment. Override with OIDC_URL in Prod.
quarkus.oidc.auth-server-url=${OIDC_URL:https://aai-dev.egi.eu/auth/realms/egi}

# Client Credentials
quarkus.oidc.client-id=${OIDC_CLIENT_ID:odrl-api}
quarkus.oidc.credentials.secret=${OIDC_CLIENT_SECRET:secret}
quarkus.oidc.application-type=service

# Map the 'scope' claim (e.g., "policies:write") to Quarkus Security Roles
quarkus.oidc.roles.role-claim-path=scope

# TLS Verification (Default to none for Dev/Testing ease, override in strict Prod envs)
quarkus.oidc.tls.verification=${OIDC_TLS_VERIFICATION:none}

# --- Swagger UI Helper Configuration ---
# This property is read by OpenApiFilter.java to configure the "Authorize" button
# It dynamically builds the token endpoint based on the OIDC URL above.
openapi.oidc.token-url=${quarkus.oidc.auth-server-url}/protocol/openid-connect/token

# ==============================================================================
# PROFILES
# ==============================================================================
# Disable OIDC in 'dev' mode (mvn quarkus:dev) for easier local testing
%dev.quarkus.oidc.enabled=false
